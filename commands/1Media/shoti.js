import axios from "axios";
import request from "request";
import fs from "fs";

export default {
  name: "ØªØ­Ù…ÙŠÙ„",
  author: "kaguya project",
  role: "member",
  description: "ØªÙ†Ø²ÙŠÙ„ Ù…Ù‚Ø§Ø·Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† ØªÙŠÙƒ ØªÙˆÙƒ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØµÙ.",

  execute: async ({ api, event, args, Economy }) => {
    api.setMessageReaction("â¬‡ï¸", event.messageID, (err) => {}, true);

    const userMoney = (await Economy.getBalance(event.senderID)).data;
    const cost = 500;
    if (userMoney < cost) {
      return api.sendMessage(`âš ï¸ | Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙ. ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ${cost} Ø¯ÙˆÙ„Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ø¬Ù„ ØªÙ†Ø²ÙŠÙ„ Ù…Ù‚Ø·Ø¹ ÙˆØ§Ø­Ø¯ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ†Ø²ÙŠÙ„ Ù…Ù‚Ø§Ø·Ø¹ Ù…Ù† ØªÙŠÙƒ ØªÙˆÙƒ ØŒ ÙÙŠØ³Ø¨ÙˆÙƒ ØŒ Ø¨Ù†ØªØ±ÙŠØ³Øª ØŒ ÙŠÙˆØªÙŠÙˆØ¨ ØŒ Ø§Ù†Ø³ØªØºØ±Ø§Ù…`, event.threadID);
    }

    // Ø§Ù„Ø®ØµÙ… Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
    await Economy.decrease(cost, event.senderID);

    try {
      const description = args.join(" ");
      if (!description) {
        api.sendMessage(
          "[!] ÙŠØ¬Ø¨ ØªÙ‚Ø¯ÙŠÙ… ÙˆØµÙ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.",
          event.threadID,
          event.messageID
        );
        return;
      }

      // Fetch user data to get the user's name
      const userInfo = await api.getUserInfo(event.senderID);
      const senderName = userInfo[event.senderID].name;

      // Send initial message
      const sentMessage = await api.sendMessage(
        `ğŸ•Ÿ | Ù…Ø±Ø­Ø¨Ù‹Ø§ @${senderName}ØŒ Ø¬Ø§Ø±Ù ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...`,
        event.threadID
      );

      const response = await axios.get(`https://for-devs.onrender.com/api/alldl?url=${encodeURIComponent(description)}&apikey=api1`);
      const videoData = response.data;

      if (!videoData.status || !videoData.result || !videoData.result.downloadUrls || videoData.result.downloadUrls.length === 0) {
        api.sendMessage("âš ï¸ | Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØµÙ Ø§Ù„Ù…Ù‚Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", event.threadID);
        return;
      }

      const videoUrl = videoData.result.downloadUrls[0].url; // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙˆÙ„ URL Ù…Ù† downloadUrls
      const videoTitle = videoData.result.title; // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
      const filePath = `${process.cwd()}/cache/tikdl.mp4`;

      // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­ Ø¨Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³ØªØ¬Ø§Ø¨Ø© HTTP
      request.head(videoUrl, (err, res) => {
        if (err || res.statusCode !== 200) {
          api.sendMessage("âš ï¸ | Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ù…ØªØ§Ø­.", event.threadID);
          return;
        }

        // Ù‚Ù… Ø¨ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø¤Ù‚Øª
        const videoStream = request(videoUrl).pipe(fs.createWriteStream(filePath));
        videoStream.on("close", () => {
          api.unsendMessage(sentMessage.messageID); // Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹Ù‡Ø§ Ø¨ "â¬‡ï¸"
          api.setMessageReaction("âœ…", event.messageID, (err) => {}, true);

          const messageBody = `â•¼â•¾â”€â”€â”€â”€â”€âŠ¹âŠ±âŠ°âŠ¹â”€â”€â”€â”€â”€â•¼â•¾\nâœ… | ØªÙ€Ù… ØªÙ€Ø­Ù€Ù…Ù€ÙŠÙ€Ù„ Ø§Ù„Ù€ÙÙ€ÙŠÙ€Ø¯ÙŠÙ€Ùˆ\nğŸ“ | Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${videoTitle}\nâ•¼â•¾â”€â”€â”€â”€â”€âŠ¹âŠ±âŠ°âŠ¹â”€â”€â”€â”€â”€â•¼â•¾`;

          api.sendMessage(
            {
              body: messageBody,
              attachment: fs.createReadStream(filePath),
            },
            event.threadID,
            () => fs.unlinkSync(filePath) // Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
          );
        });
      });
    } catch (error) {
      console.error(error);
      api.sendMessage("âš ï¸ | Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", event.threadID);
    }
  },
      }
